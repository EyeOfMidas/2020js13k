<!DOCTYPE html>
<html lang="en_us">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        #game {
            width: 100%;
            height: 100vh;

        }
    </style>
</head>

<body>
    <div id="game"></div>
    <script src="./KeyCode.js"></script>
    <script src="./manualtween.js"></script>
    <script src="./overworld-scene.js"></script>


    <script>
        var canvas;
        var context;
        var lastTime;
        var updateIntervalId;
        var gameTicks;

        var camera = { x: 0, y: 0, center: { x: 0, y: 0 }, movementSpeed: 3 };
        var isDragging = false;
        var dragCompleted = false;
        var startDrag = { x: 0, y: 0 };
        var dragDelta = { x: 0, y: 0 };
        var keys = [];

        var states = [];
        states.push(new OverworldScene());
        var activeState = states[0];
    </script>
    <script>
        function animate() {
            context.save();
            context.translate(0.5, 0.5);
            clearFrame(context);
            draw(context);
            context.restore();
            requestAnimationFrame(animate);
        }

        function clearFrame(context) {
            context.fillStyle = "#000000";
            context.beginPath();
            context.rect(0, 0, canvas.width, canvas.height);
            context.fill();
        }

        function init() {
            lastTime = new Date().getUTCMilliseconds();
            context = canvas.getContext('2d');

            keys = [];
            for (let i = 0; i < 256; i++) {
                keys[i] = false;
            }

            gameTicks = 0;

            onResize();
            activeState = states[0];
        }

        function update(delta) {
            activeState.update(delta);
        }

        function draw(context) {
            activeState.draw(context);
        }

        function onResize() {
            let dpi = window.devicePixelRatio;
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            context.width = canvas.clientWidth / dpi;
            context.height = canvas.clientHeight / dpi;

            camera.center.x = canvas.width / 2;
            camera.center.y = canvas.height / 2;
            activeState.onResize();
        }

        function onKeyDown(event) {
            keys[event.keyCode] = true;
            activeState.onKeyDown(event);
        }

        function onKeyUp(event) {
            keys[event.keyCode] = false;
            activeState.onKeyUp(event);
        }

        function onMouseMove(event) {
            activeState.onMouseMove(event);
        }

        function onMouseDown(event) {
            activeState.onMouseDown(event);
        }

        function onMouseUp(event) {
            activeState.onMouseUp(event);
        }

        function onRightClick(event) {
            activeState.onRightClick(event);
        }

        function onTouchStart(event) {
            activeState.onTouchStart(event);
        }

        function onTouchMove(event) {
            activeState.onTouchMove(event);
        }

        function onTouchEnd(event) {
            activeState.onTouchEnd(event);
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", event => {
            canvas = document.createElement("canvas");
            document.getElementById("game").appendChild(canvas);
            init();
            animate();

            updateIntervalId = setInterval(() => {
                let currentTime = new Date().getUTCMilliseconds();
                update(1 + ((currentTime - lastTime) / 1000));
                lastTime = currentTime;
            }, 16);
        });

        window.addEventListener("resize", onResize);
        window.addEventListener("keydown", onKeyDown);
        window.addEventListener("keyup", onKeyUp);
        window.addEventListener("mousedown", onMouseDown);
        window.addEventListener("mousemove", onMouseMove);
        window.addEventListener("mouseup", onMouseUp);
        window.addEventListener("contextmenu", onRightClick);

        window.addEventListener("touchstart", onTouchStart);
        window.addEventListener("touchmove", onTouchMove);
        window.addEventListener("touchend", onTouchEnd);
    </script>

    <script>

    </script>

</body>

</html>
